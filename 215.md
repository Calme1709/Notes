# CS215 (University Of Auckland)

## OSI
* 7 - Application Layer, this layer creates and processes the data.
* 6 - Presentation Layer, this layer formats data to be sent across networks.
* 5 - Session, this layer is rarely used in current TCP/IP systems and is part of the TCP protocol
* 4 - Transport Layer, TCP or UDP protocols
* 3 - Network Layer, This is the layer which IP is relevant.
* 2 - Data Link Layer, This facilitates the node-node transport of "Packets", this is the layer at which MAC addresses are relevant.
* 1 - Physical layer, only works with raw bit streams over physical mediums.

## Network Components
---
#### Hosts
A host is a device connected to a network that is part of the application layer, i.e. a Laptop, or a smart switch.

#### Interfaces
An interface is the physical part of the host that connects to the network. i.e. Ethernet, WiFi, USB.

#### Links
A link enables information exchange between two interfaces, i.e. A ethernet cable connecting two ethernet interfaces, or two WiFi interfaces are within range of each other.

#### Nodes
A node is a device on the network, this includes all hosts, routers, etc

#### Switches
A switch is used to connect multiple interfaces together creating a network.

A switch has a switching table, each time it receives a packet with a source mac address it will write that MAC address and interface in the switching table.

When a switch receives a packet it will look in it's switching table for the destination MAC address, if it exists in it's switching table it will transmit it on the associated interface, else it will transmit on all interfaces.

Problems can arise with multiple switches connected in a loop, for example:

```
  A
 / \
B - C
```

This can cause issues if for example switch A receives a packet for which it does not have the destination address in its switching table, it will then output to both B and C and then C will again transmit this to B, causing B to transmit again to A, etc, causing network congestion.

The switches will work to create a representation of the topology to make some ports readonly and will not transmit on those ports to avoid loops, i.e A could make the port that switch B is connected to readonly.
#### Routers
A router connects multiple networks.

#### Hub
A repeater forwards all incoming data to all other connected interfaces.

## Network Topologies
---
#### Star
A star topology is when there is a single centre node which the other nodes are all connected to by a single link.

#### Line
A line topology is when the nodes are in a line and must pass through one another to get from one end to the other.

#### Ring
Ring topology is when the nodes are connected in a circle.

#### Bus
Bus topology is when there is a single link which each of the nodes shares.

#### Mesh
Mesh is when many or all hosts have at least two links.

#### Mixed
Mixed topology is when multiple of the aforementioned topologies are used together.

### Communication Protocols
---
A communication protocol defines how hosts and interfaces communicate which each other.

A protocol defines:
- The possible actions, states, and events of a host.
- The format, syntax, and semantics of the protocol.
- How to mitigate errors and synchronize.

#### Protocol Correctness
A correct protocol defines:
- A complete set of states, including error and unsynchronised states.
- An appropriate action for every event that may occur in every state.
- Unambiguous formats, syntax, and semantics.

## Physical Layer
### No Transmission Taking Place
There are two scenarios with physical layers, ones that can tell when no transmission is taking place:

WiFi (Can tell):
* 1: Positive voltage
* 0: Negative voltage
* No Transmission: No voltage.

Optical Fibre (Can't tell):
* 1: Light On
* 0: Light Off
* No Transmission: Light Off

### Physical layer protocol
The physical layer's purpose is to be able to get symbols (usually bits or multiple bits) from one interface to another.
- Define a signal level and other signal parameters (Semantics)
  - Part of defining the states, i.e. we define a voltage that represents a one and a voltage that represents zero.
- Define a signal timing (Format)
  - This helps in synchronisation and in determining actions.
  - This defines how long each symbol should be transmitted for to be interpreted as a single symbol.
- Define a permitted signal sequence (syntax)
  - For example having a parity bit.
#### Alternate Interpretation depending on timing
Say we have a protocol where 1 is high and 0 is low. Take the transmission:
1100111100

This can be interpreted in multiple ways depending on the expected timing:
* 1100111100
* 10110

#### Example Physical layer protocol: Morse Code
* Semantics: 2 Signal levels (on/off)
* Format: Timing depends but there is a space after each signal and dot is 1/3 the length of dash.
* Syntax: Spacing, letter sequences, words.

## Data Link Layer
The data link layer is responsible for forming frames to transmit across the physical layer.

### Signalling that transmission is occurring
Frame Headers(and trailers) need to use a format that contains a pattern that a receiving interface can listen for to distinguish between transmission and no transmission if this is not handled by our physical layer.

This is often done by at the start including the byte x7E at the start of the frame and a checksum at the end.

We then insert a zero after every time that five ones occur in a row in the frame to ensure that the frame start marker is unique in the frame.

### Local Addressing
This is needed only when multiple interfaces can hear the same physical transmission, therefore it is needed for bus topologies or WiFi but not for 1-1 communication.

#### MAC addresses
* Quasi standard for local addressing.
* Usually 6 bytes, sometimes 8 bytes.
* Generally unique for each interface and hardcoded in the interface, but can often be overridden in software.
* Contain an OUI, usually 3 bytes long, which can be used to identify the interface manufacturer.
* Not a routable address.
* If overwritten it can be used to impersonate another interface.
* Usually written as a string of two digit hex numbers separated by colons or hyphens.

### Frame Format
* Header
  * Destination MAC address
  * Source MAC address
  * Other data link specific data
* Payload
  * The payload (the data) of the frame. 
* Trailer
  * The checksum for the frame.

### Media Access Control SubLayer
On a shared physical layer we can only transmit from one interface at a time, otherwise the physical transmissions will collide and the receiving interface will receive nonsense.

This only occurs on shared physical layers.

#### CSMA/CD
Carrier Sense Multiple Access with Collision Detection.

This process can be modelled as:
```
			Interface ready to transmit
					|
		Y			V
Random 	<- 	Physical Medium is busy
Wait				| N
Time				V
	^			Transmit
	|				|
	|	Y			V
	-----	Check for collision
					|
					V
				   Done
```

We wait a random time to avoid repeat collisions

##### Random wait time
###### Granularity:
Choose the random time not completely randomly but in steps to account for the signal propagation time, and the duration of the transmissions, this decreases the chance of a collision.

###### Range:
The range for random wait times is a balancing act:
* Large range: Low chance of collisions but low efficiency use of the physical layer
* Small range: High chance of collisions.
* Best choice is somewhere in between, can be calculated depending on the amount of active interfaces.

#### Other Media Access Protocols
There are others that use different methods to avoid collisions
* Fixed or reserved time slots
* Sub channels on the physical channel
* Protocols that avoid collisions using math
* Protocols that don't try to avoid collisions.

#### Error Correction and detection
##### Error Detection
* Usually done with checksums (CRC)
* Frames with errors are dropped
  
#### Error Correction
* Uses special codes such as Hamming codes to reconstruct damaged frames

### LLC SubLayer
Detecting unsuccessful transmission
* Detection of collision
  * Easy to do on wired physical layers but harder or impossible on wireless physical layers.
* ACK
  * Get receiving interface to respond with an ACK packet to confirm receipt.
  * We can expect this packet to arrive within a certain time and if it does not retransmit.
#### ACK
An ACK frame will identify:
* Which frame it is ACKing: usually with a sequence number, usually revolving so we can only transmit once the sequence number we want to use has been ACKed.
* Whose frame: Usually done with the MAC address in the header.

* Individual ACKs: Send an ACK frame for each received frame
* Cumulative ACKs: Send an ACK frame acknowledging multiple frames.
* NACKs: Sends and ACK which specifies the frames not received.
* SACKs: Acknowledges each of the frames received in a single frame.
#### RTT
Round trip time is calculated as the time it takes for a transmission to go from one interface and back.

We can use this as our timeout for ACK transmissions, with a bit of leeway in case either transmission is delayed for any reason.

### Transmission and propagation time
Two times matter for the time it takes a transmission to occur.
* Transmission Time: The time it takes for an interface to transmit the data.
* Propagation Time: The time it takes for the transmission to get from one interface to the other.

### Effective Data Rate
The number of bits transmitted per second. This is the number of bits that are transmitted per second including the time that the interface is not transmitting.

If we wait for an ACK for each frame we spend a long time waiting between each frame. Therefore we send each packet without waiting for the previous packet's ACK to return.

If we wait for each frame's ACK the effective data rate can be calculated as
```
payload / (2 * propagation time)
```

## Network Layer
### IP Address
#### IPv4
* 4 Bytes long
* Common written in dotted-decimal i.e. 192.168.1.1 <-> 11000000101010000000000100000001
* Currently more common
* Only 4.3 billion addresses
#### IPv6
* 16 Bytes long
* Commonly written in hexadecimal format with : separators i.e. a23d:09fb:0000:0000:0000:48ca:0000:0000
* 2^128 addresses

#### NetID and HostID
* NetID: This is the identifier for the network that the host is in.
  * All hosts in a network have the same NetID
  * This is what routers exchange when communicating.
  * It is computed using the netmask or CIDR
* HostID: This is the identifier for the host in it's network.
  * Hosts in a network should have unique HostIDs
  * It is the part of the IP address which is not the NetID
  * The amount of possible hosts on a network is equal to (2 ^ lengthOfHostID) - 2. The minus two accounts for the network address HostID: 0, and the broadcast address, HostID: Maximum value.

#### Netmask and CIDR
Netmask and CIDR are both ways to decode the NetID from the IP address.
* Netmask is a 32 bit number. 1s in the netmask identify that the corresponding bit in the IP address is part of the NetID.
  * It is encoded in dotted decimal. i.e. 255.255.255.0
* CIDR is an alternative method of encoding this, it is the length of the NetID.
  * It is encoded following the IP address as a forward slash and then the length of the NetID. i.e 192.168.1.0/24

#### Broadcast Addresses
The broadcast address for a network is where all of the bits of the HostID are set to one.
This broadcasts the packet to all hosts in the network.

#### IP Address assignment
* Third party assignment
  * Assigned by ISP who got it from RIR
  * RIR got it from ICANN/IANA
* Static IP address, manually set by the admin of the machine.
* DHCP
  * Interface broadcasts (see IP broadcast address) a DHCPDISCOVER message.
  * DHCP Server responds offering IP

##### DHCP Packets
* DHCPDISCOVER
  * UDP Datagram from port 67 to port 68
  * Containing:
    * Client MAC Address
    * Parameter list of what information is required:
      * Subnet mask
      * Gateway address
      * DNS Server
      * Domain Name
      * etc
  * Contained within IP Packet with header information:
    * Source IP: 0.0.0.0
    * Destination IP: 255.255.255.255
  * Contained within a frame with header information:
    * Source MAC: Client MAC address
    * Destination MAC: FF:FF:FF:FF:FF:FF
* DHCPOFFER
  * UDP Datagram from port 67 to port 68
  * Containing:
    * Client MAC Address
    * Offered IP Address, subnet mask, gateway address, DNS server, domain name, etc
    * IP Address Lease Period usually a day
  * Contained within IP Packet with header information:
    * Source IP: DHCP Server IP Address
    * Destination IP: 255.255.255.255
  * Contained within a frame with header information:
    * Source MAC: DHCP Server MAC address
    * Destination MAC: Client MAC address

Only for static IP?
* DHCPREQUEST
  * UDP Datagram from port 67 to port 68
  * Containing:
    * Client MAC Address
    * Server IP Address
    * Client IP Address offered
  * Contained within IP Packet with header information:
    * Source IP: 0.0.0.0
    * Destination IP: 255.255.255.255
  * Contained within a frame with header information:
    * Source MAC: Client MAC Address
    * Destination MAC: FF:FF:FF:FF:FF:FF
* DHCPACK
  * UDP Datagram from port 67 to port 68
  * Containing:
    * Client MAC Address
    * Offered IP Address, subnet mask, gateway address, DNS server, domain name, etc
  * Contained within IP Packet with header information:
    * Source IP: DHCP Server IP Address
    * Destination IP: 255.255.255.255
  * Contained within a frame with header information:
    * Source MAC: DHCP Server MAC address
    * Destination MAC: Client MAC address

#### IP Packets
IP Packet makeup:

|Data Link Layer Header| IP Header | Transport Layer Header | Transport Layer Payload | Data Link Layer Checksum|
|:---|:---|:---|:---|:---|

#### IP Address to MAC address mapping
* Source MAC Address: This is always the MAC address of the interface sending or forwarding the packet.
* Destination MAC address:
	* Destinations inside of the local network (as defined by the sending interface's netmask): MAC Address of the final host
	* Destinations outside of the local network: MAC Address of the gateway router.

#### ARP
* ARP is used to find the MAC address of an interface with the specified IP address.
* ARP is part of the Data link layer.
* Works as follows:
  * Send an ARP request.
  * Wait for ARP response.
  * Cache the response.

##### ARP Packets
Sent inside of a data link frame, not an IP packet, it contains the following information:
* Operations (1 = request, 2 = response)
* Sender MAC Address
* Sender Protocol Address (Usually IP address but ARP supports other protocols as well)
* Target MAC Address (0 filled for the request)
* Target Protocol Address

##### ARP Requests
The sender decides what is required, based on IP address A and it's netmask.
* If the destination IP A is in the local network
  * Check the local ARP table to see whether there is a MAC address already for A.
  * Else send an ARP request for A.
* If A is not local: We need the MAC for the IP Address G of the gateway router.
  * Check the local ARP table for G.
  * If not send an ARP request for G.

#### Routers
Routers can be misconfigured causing a loop.

##### TTL
Each IP packet contains a TTL (More accurately called hop limit) number which is decremented each time it is processed by a router, if this number reaches zero it is dropped unless the router is the destination.

#### Routing tables
A router maintains a routing table which contains information about the networks it is connected to:
|Network Address|Netmask|Interface|Gateway|Metric|
|:--|:--|:--|:--|:--|

##### Indirect Routes
There are indirect routes which are given lower priority in routing that contain a gateway entry specifying the IP of the gateway router to go via.

##### Routing
When a router receives a packet it applies the netmask of each of it's connected networks (excluding the one it received the packet from) to the destination IP and checks to see if the resultant NetID is equal to the connected network's NetID.
* If it finds a single suitable network or indirect entry it forwards the packet on the associated port.
* If it finds multiple suitable networks
  * If the netmasks are not the same length it forwards the one with the longer netmask.
  * Else it forwards to the one with the lower metric.
* If no route is found the packet is dropped and an ICMP "No route to host" message is returned.

##### Martian Packets
If we receive a packet for which we have no route to the source, we drop this packet.

#### Private IP Addresses
These are reserved for private networks and are not assigned by ISPs. These IP addresses are part of the networks:
* 10.0.0.0/8
* 100.64.0.0/10
* 172.16.0.0/12
* 192.168.0.0/16

These IP addresses are dropped by routers on the internet.

#### Subnetting
Divide a large network into smaller subnets

* Make subnets large enough to accommodate all hosts.
* Be economical with addresses, make subnets no larger than required.

Done by increasing the length of the NetID.

## Transport layer
The transport layer defines protocols for data transfer between applications on hosts.

### ARQ
ARQ is short for automatic repeat request, a protocol is an ARQ protocol if it works with ACKs and timeout based retransmissions.

#### End-to-end ARQ
Pros:
* Routers don't need to keep track of what was received and what wasn't
* End to end delay and packet loss give sender information about congestion control.

Cons:
* ACK takes a long time to get back to sender (lower the effective data rate if retransmissions are required.)
* Packet loss takes a long time to detect.
* Packets lost on downstream links need to be transmitted more than once on links upstream from the packet loss.
#### Hop-to-hop ARQ
Pros:
* Transmission to ACK completes faster
* Faster recovery after packet loss
* Data is only transmitted once across each link.

Cons:
* Routers must keep track of what they should and shouldn't ACK
* Original sender gets no feedback about congestion downstream.

### Connections
A connection between two hosts is an agreement about data exchange between two applications on the two hosts.
* Agreement to communicate
* Agreement on sequence numbers to use
* Agreement the connection has been established
* Ability to terminate connection.

Connections have states (request, established, closed, etc)

A connection mus tbe established on the initiative of at least one of the hosts (the client) and confirmed by another (the server).

Both hosts can terminate the connection.

### TCP
* Main transport protocol on the internet today.
* Designed to work well with IPv4 but also works on IPv6.
* All traffic is part of a connection.
* ARQ using ACKs
* Packets carry a 4 byte sequence number
* Flow control and congestion control.

#### TCP Packet
A TCP packet is in the following format:

![TCP Packet Format](https://github.com/Calme1709/Notes/raw/master/TCP%20Header.png)

#### Three way handshake
- The host starting the connection (Alpha) will send a single packet:
	- An empty payload
	- A random SEQ
	- A random unimportant ACKNO (usually zero)
	- And the following flags: SYN

- The other host (Bravo) will sent a packet in response with
	- An empty payload
	- A random SEQ
	- ACKNO set to the sequence number of the packet received from Alpha plus one
	- And the following flags: SYN, ACK
	
- Alpha will send another packet with:
	- An empty payload
	- A SEQ equal to the SEQ of the first packet plus one.
	- ACKNO set to the SEQ of the packet received from Bravo plus one.
	- The following flags set: ACK
	
- The two hosts can then begin to transmit data between themselves

#### SEQ
- The sequence number is set randomly by each host during the three way handshake
- This incremented by the size of the payload of each packet.

#### ACKNO
- This is sent with each packet, it is set to the sequence number of the next expected packet.

#### Duplicate ACK
- Is sent if a packet is received out of order, i.e. the previously sent ACK is not equal to the sequence number

- Will trigger a resend of all packets with sequence numbers equal to or greater than the ACKNO.
- If it is received within the estimated round trip time (RTT) the packets will not be retransmitted as it is assumed the packet has not yet arrived.

#### ACK Timeout
- If a packet is sent and an ACK is not received within a specified timeout the packet will be resent.

#### ACK
- Only set if payload is received in a packet (not sent for pure ACK packets)
- Is not necessarily sent for all received packets, can combine multiple in a cumulative ACK packet, which is just the ACK packet for the last received packet.

#### Buffers
- Transmit buffer (AKA Sender buffer)
	- Application layer writes data to this buffer
	- TCP takes the data for the payloads from this buffer

	- Regions
		- ACKed data.
			- This data has been sent and acknowledged, it can be removed from memory at any time
		- Transmitted, non-ACKed
			- This data has been transmitted but an acknowledgement is yet to be received,
				  it cannot be removed from memory in case it needs to be retransmitted in the
				  case the packet it was contained in is lost

			- The size of this (TCP transmission window) is usually capped so that we don't continue
				  to send packets when they are not getting acknowledged, meaning the connection is broken.
		- Awaiting Transmission
			- This data is yet to be transmitted.
		- Empty buffer space
			- This is empty memory, the application layer can write to this part of memory to queue data for transmission.

	- Pointers
		- ACK Pointer (The end of the ACKed region, start of the Transmitted non-ACKed region)
			- Incremented on ACK receives
		- Transmit Pointer (The end of the Transmitted non-ACKed region, start of the Awaiting transmission region)
			- Incremented on transmission of new data
			- Set on duplicate ACK arrival
		- Write Pointer (The end of the Awaiting Transmission region, the start of the empty buffer)
			- Incremented with application layer writes.

- Receive buffer
	- TCP writes the received payloads to this buffer
	- Application layer reads data from here.

	- Regions
		- Data for application
			- This data has been received and there are no missing packets, meaning it can be read by the application layer.
		- Received data
			- This data has been received but it is fragmented (there are missing packets),
				  meaning we must wait until those packets arrive before we can read the data.
		- Available buffer space
			- This region is empty and can be written to by the TCP layer.
		
	- Pointers
		- Application buffer Pointer (The start of the data for application region)
			- Incremented on application layer read
		- Complete byte stream end pointer (End of the Data for application region, start of Received data region)
			- Incremented when there are packets added which make the unbroken byte stream longer.
		- Available buffer pointer (End of received data region, start of available buffer space region)
			- Incremented on receipt of packet at the end of the stream according to sequence number
		- End of buffer pointer (End of the available buffer space region)
#### Windows
- Receive window
	- The amount of space that is available in the Available Buffer Space region of the Receive buffer. Used by the sender to not overload the receiver.
- Congestion window
	- The amount of packets the sender is willing to have transmitted but non-acked at any one time.

### DNS
Hostname - The hostname usually means something to a human. E.g.:
* www: web server
* mail: mail server

Domain Name - The name for a group of hosts. E.g.:
* .auckland.ac.nz
* .google.com
* .org

Domain names are hierarchial:
* .auckland.ac.nz: hosts in this domain name are a subset of:
  * hosts in .ac.nz: which are a subset of hosts in:
    * .nz

A FQDN is a fully qualified domain name which is a domain name with a host name attached: i.e. www.auckland.ac.nz

Every FQDN maps to one IP address (usually).
One IP address can map to multiple FQDNs.

Mapping is maintained by DNS (Domain Name System/Service).

DNS is used to query the IP address of FQDNs.

#### DNS Servers
A host has a DNS server that it sends DNS lookup queries to. DNS Lookup uses UDP port 53.

DNS Servers know about and keep a list of other DNS servers particularly DNS servers for TLDs:
* .nz
* .uk
* .com

##### FQDNS that a DNS server knows:
* FQDNs it is authoritative for
* FQDNs it has cached from past queries

##### Answering methods
* Recursively
  * The DNS server will query the next server in the chain and then return that server's response.
* Iteratively
  * The DNS server will return the IP of the next server in the chain, and the host will query the next server in the chain.
* Non-recursively
  * The server will respond from the information it knows.

### Ports
TCP and UDP identify different applications by the port numbers they use.
* Client sent packets
  * Source
    * Chosen by the OS from a pool of ports not being used.
  * Destination
    * Provided to the client or convention (i.e. HTTP port 80)
* Server sent packets
  * Source
    * Destination port used by the client.
  * Destination
    * Source port used by the client

#### Common ports
|Port|Protocol|Application|
|:--|:--|:--|
|22|TCP|SSH|
|25|TCP|SMTP (Email)|
|53|UDP|DNS|
|67/68|UDP|BOOTP (DHCP)|
|80|TCP|HTTP|
|110|TCP|POP3|
|123|UDP|NTP|
|143|TCP|IMAP|
|443|TCP|HTTPS|

### Firewalls
* Admit or block traffic based on certain characteristics
  * IP Source or destination address
  * Transport layer protocol or port
  * Packet Content
* Firewall types
  * Host based
  * Router based
  
#### Host based
Determine which applications may access the network as clients or servers.

Determines which ports and protocols are open.

Examples:
* Windows Firewall
* iptables
* UFW
* pfSense

#### Router based
Determine which traffic may pass in which direction
* Based on source or destination host or network
* Based on protocol or port
* Packet content/header flags
  
Other uses
* Traffic shaping - Make sure no user or subnet particular rate or volume
* Allow access for authenticated IP addresses.
